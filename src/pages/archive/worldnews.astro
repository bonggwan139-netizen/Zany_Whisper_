---
import Layout from '../../layouts/Layout.astro';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.resolve(__dirname, '../../..');
const newsDataPath = path.resolve(projectRoot, 'src/data/daily-news.json');

let newsData = {
  updatedAt: new Date().toISOString().split('T')[0],
  categories: {
    world: [],
    science: [],
    economy: []
  },
  errors: []
};

try {
  if (fs.existsSync(newsDataPath)) {
    const rawData = fs.readFileSync(newsDataPath, 'utf-8');
    newsData = JSON.parse(rawData);
  }
} catch (error) {
  console.warn('Error loading news data:', error.message);
}

const categoryLabels = {
  World: 'ğŸŒ ì„¸ê³„ ë‰´ìŠ¤',
  Science: 'ğŸ”¬ ê³¼í•™ ë‰´ìŠ¤',
  Economy: 'ğŸ’° ê²½ì œ ë‰´ìŠ¤'
};

const categoryOrder = ['World', 'Science', 'Economy'];
---

<Layout>
  <div id="news-container">
    <header id="news-header">
      <h1>Daily World & Science & Economy News</h1>
      <p>ë§¤ì¼ 08:00 KST ê¸°ì¤€ ìµœì‹  ë‰´ìŠ¤ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤</p>
      <div class="last-updated">
        ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {newsData.updatedAt}
      </div>
    </header>

    <div id="notice" class="notice">
      <p>
        â„¹ï¸ ì´ í˜ì´ì§€ëŠ” <strong>ì˜¤ëŠ˜ ë°ì´í„°ë§Œ</strong> í‘œì‹œí•©ë‹ˆë‹¤.
        ë§¤ì¼ ìë™ìœ¼ë¡œ ìµœì‹  ë‰´ìŠ¤ë¡œ ê°±ì‹ ë˜ë©°, ê³¼ê±° ê¸°ì‚¬ëŠ” GitHub ì»¤ë°‹ íˆìŠ¤í† ë¦¬ë¥¼ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
    </div>

    {categoryOrder.map(category => (
      <section class="news-category">
        <h2 class="category-title">{categoryLabels[category]}</h2>
        <div class="sources-grid">
          {newsData.categories && newsData.categories[category] && newsData.categories[category].length > 0 ? (
            newsData.categories[category].map((sourceEntry) => (
              <div class="source-card" id={sourceEntry.source.replace(/\s+/g, '-')}> 
                <h3 class="source-name">{sourceEntry.source}</h3>
                {(!sourceEntry.items || sourceEntry.items.length === 0) ? (
                  <div style="margin:8px 0; display:flex; gap:8px; align-items:center;">
                    <span class="failed-badge">ìˆ˜ì§‘ ì‹¤íŒ¨</span>
                    <span class="failed-reason">{(newsData.errors && newsData.errors.find(e=>e.source===sourceEntry.source && e.category===category) || {}).reason || sourceEntry.error || 'ë°ì´í„° ì—†ìŒ'}</span>
                  </div>
                ) : null}

                <ul class="article-list">
                  {sourceEntry.items && sourceEntry.items.length > 0 ? (
                    sourceEntry.items.map((article) => (
                      <li class="article-item">
                        <div class="article-header">
                          <a href={article.link} target="_blank" rel="noopener noreferrer" class="article-title-ko">
                            {article.titleKo}
                          </a>
                        </div>
                        <div class="article-original-title">{article.titleEn}</div>
                        <div class="article-summary">{article.summary}</div>
                        <div class="article-meta">
                          <a href={article.link} target="_blank" rel="noopener noreferrer" class="source-link">ì›ë¬¸ ë³´ê¸° â†’</a>
                        </div>
                      </li>
                    ))
                  ) : (
                    <li class="article-item no-data">ìˆ˜ì§‘ëœ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                  )}
                </ul>
              </div>
            ))
          ) : (
            <p class="no-data">ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          )}
        </div>
      </section>
    ))}

    <footer class="news-footer">
      <p>
        <strong>ğŸ“Œ ì •ë³´:</strong> ì´ ë‰´ìŠ¤ëŠ” RSS í”¼ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìˆ˜ì§‘ ë° ë²ˆì—­ë©ë‹ˆë‹¤.
        ì›ë¬¸ì„ í™•ì¸í•˜ì‹œê³  ë” ìì„¸í•œ ë‚´ìš©ì€ ì¶œì²˜ ë§í¬ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
      </p>
    </footer>
  </div>
</Layout>

<style>
  #news-container {
    font-family: Inter, Roboto, 'Helvetica Neue', 'Arial Nova', 'Nimbus Sans', Arial, sans-serif;
    max-width: 1200px;
    margin: 0 auto;
    padding: 60px 16px 80px;
    color: #111827;
  }

  #news-header {
    text-align: center;
    margin-bottom: 48px;
  }

  #news-header h1 {
    font-size: 36px;
    margin: 0 0 12px;
    color: #111827;
    font-weight: 700;
  }

  #news-header p {
    font-size: 16px;
    color: #6b7280;
    margin: 0 0 16px;
    line-height: 1.6;
  }

  .last-updated {
    font-size: 13px;
    color: #9ca3af;
    font-weight: 500;
  }

  .notice {
    background: #f0f9ff;
    border-left: 4px solid #3b82f6;
    padding: 16px;
    border-radius: 6px;
    margin-bottom: 48px;
    font-size: 14px;
    color: #1e40af;
  }

  .notice p {
    margin: 0;
    line-height: 1.6;
  }

  .news-category {
    margin-bottom: 56px;
  }

  .category-title {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 32px;
    color: #111827;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb;
  }

  .sources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 32px;
  }

  .source-card {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 24px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .source-card:hover {
    border-color: #6db3e8;
    box-shadow: 0 4px 12px rgba(109, 179, 232, 0.1);
  }

  .source-name {
    font-size: 16px;
    font-weight: 700;
    color: #1e40af;
    margin: 0 0 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e5e7eb;
  }

  .article-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .article-item {
    padding: 16px;
    background: #f9fafb;
    border-radius: 6px;
    border-left: 3px solid #6db3e8;
  }

  .article-header {
    margin-bottom: 8px;
  }

  .article-title-ko {
    font-size: 15px;
    font-weight: 600;
    color: #111827;
    text-decoration: none;
    line-height: 1.4;
    display: inline-block;
    transition: color 0.2s;
  }

  .article-title-ko:hover {
    color: #6db3e8;
    text-decoration: underline;
  }

  .article-original-title {
    font-size: 12px;
    color: #6b7280;
    font-style: italic;
    margin-bottom: 12px;
    line-height: 1.3;
  }

  .article-summary {
    font-size: 13px;
    color: #374151;
    line-height: 1.6;
    margin-bottom: 12px;
    background: white;
    padding: 12px;
    border-radius: 4px;
    white-space: pre-line;
  }

  .failed-badge {
    display: inline-block;
    background: #fee2e2;
    color: #b91c1c;
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 700;
  }

  .failed-reason {
    font-size: 12px;
    color: #6b7280;
  }

  .summary-line {
    margin-bottom: 4px;
  }

  .summary-line:last-child {
    margin-bottom: 0;
  }

  .article-meta {
    display: flex;
    justify-content: flex-end;
  }

  .source-link {
    font-size: 12px;
    color: #6db3e8;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s;
  }

  .source-link:hover {
    color: #40b0db;
    text-decoration: underline;
  }

  .no-data {
    text-align: center;
    color: #9ca3af;
    padding: 40px 20px;
    font-size: 14px;
  }

  .article-list .no-data {
    padding: 20px;
    text-align: center;
    color: #9ca3af;
    background: #fff5f5;
    border-radius: 6px;
  }

  .news-footer {
    margin-top: 56px;
    padding: 24px;
    background: #f9fafb;
    border-radius: 8px;
    border-left: 4px solid #6db3e8;
    font-size: 13px;
    color: #6b7280;
    line-height: 1.8;
  }

  .news-footer p {
    margin: 0;
  }

  @media screen and (max-width: 768px) {
    #news-container {
      padding: 40px 12px 60px;
    }

    #news-header h1 {
      font-size: 28px;
    }

    .sources-grid {
      grid-template-columns: 1fr;
      gap: 24px;
    }

    .category-title {
      font-size: 20px;
    }
  }
</style>
